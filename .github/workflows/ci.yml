name: CI

on: push

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
          - os: ubuntu-24.04
          - os: ubuntu-latest
            container: docker://archlinux:latest
          - os: macos-15-intel
          - os: macos-26
          - os: windows-2022
          - os: windows-2025

    steps:
    - uses: actions/checkout@v5

    - name: Install dependencies (Ubuntu 22.04)
      if: matrix.os == 'ubuntu-22.04' && matrix.container == null
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build g++ catch2 python3-pip 
        pip3 install nanobind pytest

    - name: Install dependencies (Ubuntu 24.04)
      if: matrix.os == 'ubuntu-24.04' && matrix.container == null
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build g++ catch2 nanobind-dev python3-pytest

    - name: Install dependencies (Arch Linux)
      if: matrix.container == 'docker://archlinux:latest'
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm cmake ninja gcc catch2 nanobind python3-pytest

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja gcc python nanobind catch2 robin-map

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        vcpkg install cmake ninja python3 nanobind catch2 --triplet x64-windows

    - name: Install Nanobind & Pytest
      run: |
        pip install nanobind pytest

    - name: Configure project
      run: |
        cmake -G Ninja -S . -B build -DCMAKE_BUILD_TYPE=RelWithDebInfo -DBUILD_PYTHON_BINDINGS=ON -DBUILD_TESTS=ON

    - name: Build project
      run: cmake --build build

    - name: Run tests
      run: ctest --test-dir build --output-on-failure
