import contextlib
import os
import sys
import platform

class DllDirectoryManager(contextlib.AbstractContextManager):
    """Context manager for managing DLL directories on Windows.
    On Windows with Python 3.8+, Python doesn't search DLL in PATH anymore
    We must specify DLL search path manually with `os.add_dll_directory`
    On Linux and MacOS, we can use DYLD_LIBRARY_PATH and LD_LIBRARY_PATH 
    environment variables, or simply the rpath search for shared libraries.
    ref: https://github.com/python/cpython/issues/87339#issuecomment-1093902060
         https://docs.python.org/3/library/os.html#os.add_dll_directory
    """
    def add_dll_directory(self, dll_dir: str):
        """Add a DLL directory to the search path."""
        # Check if the directory exists
        if os.path.isdir(dll_dir):
            self.dll_dirs.append(os.add_dll_directory(dll_dir))
        else:
            print(f"Warning: DLL directory '{dll_dir}' does not exist.", file=sys.stderr)

    def __enter__(self):
        self.dll_dirs = []
        return self

    def __exit__(self, *exc_details):
        for d in self.dll_dirs:
            d.close()

if platform.system() == 'Windows':
    with DllDirectoryManager() as mgr:
        module_path = os.path.dirname(__file__)
        mgr.add_dll_directory(os.path.join(module_path, '..', '..', '..', 'bin'))
        dll_dirs = @__DLL_DIRS__@
        for dll_dir in dll_dirs:
            mgr.add_dll_directory(os.path.join(module_path, dll_dir))

from .@__MODULE_NAME__@ import *  # noqa
if hasattr(@__MODULE_NAME__@, "__version__"):
    __version__ = @__MODULE_NAME__@.__version__ # noqa